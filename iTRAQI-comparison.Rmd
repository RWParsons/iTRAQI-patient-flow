---
title: "iTRAQI comparison"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(sp)
library(sf)
source("R/download-utils.R")
data_dir <- "U:\\Research\\Projects\\health\\jti_research_data\\jti_itraqi"
```


```{r}
df_facilities <- haven::read_spss(file.path(data_dir, "D_Table_FacilityDescription.sav")) 
df_times <- haven::read_spss(file.path(data_dir, "D_Table_TimeAndLocation_LongFileSELECT.sav"))
df_itraqi_times <- openxlsx::read.xlsx("https://github.com/RWParsons/iTRAQI/blob/main/input/drive_times/Qld_towns_RSQ%20pathways%20V3.xlsx?raw=TRUE", startRow = 3) |> janitor::clean_names()

df_itraqi_times <- openxlsx::read.xlsx("C:/Users/n10891277/R_projects/iTRAQI/input/drive_times/Qld_towns_RSQ pathways V3.xlsx", startRow = 3) |> janitor::clean_names()
```


### rearrange observed data (`df_times`) into the same/similar format to df_itraqi_times, so that it can be used in the app

```{r}
fx_shorten_path <- function(pu_id_) {
  d <- 
    df_times |> 
    filter(pu_id == pu_id_) |> 
    mutate(FACILITY_NAME_Clean = ifelse(FACILITY_NAME_Clean == "", NA, FACILITY_NAME_Clean))
  
  origin_row <- 
    d |> 
    filter(!is.na(X_COORD)) |> 
    slice(1) |> 
    mutate(NeuroSurgMajor = NA_integer_, FCLTY_ID = NA_integer_)
  
  centre_rows <-
    d |> 
    filter(!is.na(FACILITY_NAME_Clean)) |> 
    group_by(FACILITY_NAME_Clean) |> 
    arrange(DateTimePoints) |> 
    slice(1) |> 
    ungroup()
  
  if(nrow(centre_rows) == 0) return(select(origin_row, pu_id, TimeWayPoint:FACILITY_NAME_Clean, NeuroSurgMajor, FCLTY_ID, Arrival_ReferralPathway))
  
  # print(pu_id_)
  centre_rows <- centre_rows |> 
    select(-NeuroSurgMajor) |>
    mutate(FACILITY_NAME_Clean = as.character(FACILITY_NAME_Clean)) |> 
    left_join(select(df_facilities, FACILITY_NAME_Clean, Latitude, Longitude, NeuroSurgMajor, FCLTY_ID), by = "FACILITY_NAME_Clean") |> 
    mutate(X_COORD = Longitude, Y_COORD = Latitude) |> 
    select(-Latitude, -Longitude) |> 
    slice(1:which.min(NeuroSurgMajor))
  
  bind_rows(origin_row, centre_rows) |> 
    select(pu_id, TimeWayPoint:FACILITY_NAME_Clean, NeuroSurgMajor, FCLTY_ID, Arrival_ReferralPathway)
}


df_times_short <- lapply(
  unique(df_times$pu_id),
  fx_shorten_path
) |>
  (\(x) do.call("rbind", x))()
```



```{r}
# add facilities and their coords for those referred to in the RSQ pathways (iTRAQI) but not in the df_facilities
df_new_facilities_with_coords <- list(
  # FACILITY_NAME_Clean; latitude; longitude
  c("MAPOON PHC", -12.016632475931772, 141.9003317386928),
  c("COEN PHC", -13.944773159917592, 143.20149205490424),
  c("PORMPURAAW PHC", -14.899640079895562, 141.6221141698491),
  c("CHILLAGOE PRIMARY HEALTH CENTRE", -17.14997184798341, 144.52796889646453),
  c("CROYDON PRIMARY HEALTH CENTRE", -18.21097767957882, 142.2401596829941),
  c("GEORGETOWN PRIMARY HEALTH CENTRE", -18.29203373558961, 143.54786222660186),
  c("PALM ISLAND HOSPITAL", -18.730124669326756, 146.57884580498148),
  c("BOULIA PRIMARY HEALTH CENTRE", -22.908133626306732, 139.90838848311506),
  c("TEXAS HOSPITAL", -28.849736273857026, 151.17710790186513),
  c("BIRDSVILLE PRIMARY HEALTH CENTRE", -25.897497103362916, 139.35551489854396)
) %>%
  do.call("rbind", .) |> 
  data.frame() |> 
  setNames(c("FACILITY_NAME_Clean", "Latitude", "Longitude")) |> 
  mutate(across(!FACILITY_NAME_Clean, as.numeric),
         FCLTY_ID = as.numeric(paste0("999", row_number())))

df_facilities <- 
  df_facilities |> 
  filter(!FACILITY_NAME_Clean %in% df_new_facilities_with_coords$FACILITY_NAME_Clean) |> 
  bind_rows(df_new_facilities_with_coords)
```

# visualise iTRAQI paths
```{r}
source("app/app.R"); iTRAQI_vis_app(iTRAQI_paths = df_itraqi_times, facilities = df_facilities, observed_paths = df_times_short) 
```


```{r}
source("app/app.R")
iTRAQI_vis_app(iTRAQI_paths = df_itraqi_times, facilities = df_facilities, observed_paths = df_times_short) |> 
  # arrange(town_name)
  # filter(town_name == "Allingham")
  filter(town_point == "TWP31090") |> 
  # filter(str_trim(destination) == "INGHAM") |> 
  left_join(df_facilities, by = c("destination" = "FACILITY_NAME_Clean"))


mutate(df_facilities, FACILITY_NAME_Clean = str_trim(FACILITY_NAME_Clean)) |> 
  filter(FACILITY_NAME_Clean == "INGHAM")

df_facilities |> filter(FACILITY_NAME_Clean == "INGHAM")


df_facilities
# "TWP31090"
```


```{r}
df_itraqi_times |> plyr::count("destination1") |> arrange(desc(freq))

df_itraqi_dests <-
  df_itraqi_times |> 
  select(town_point, destination1, destination2) |> 
  pivot_longer(!town_point) |> 
  mutate(value = str_trim(toupper(value)))

# check that there are coordinates for all included facilities in iTRAQI paths
df_itraqi_dests |> 
  mutate(value = str_trim(toupper(value))) |> 
  select(value) |> 
  distinct() |> 
  rownames_to_column("n") |> 
  filter(!is.na(value)) |> 
  left_join(df_facilities, by = c("value" = "FACILITY_NAME_Clean")) |> 
  filter(is.na(Latitude))

df_itraqi_dests |> 
  select(value) |> 
  distinct() |> 
  mutate(value = toupper(value)) |> 
  rownames_to_column("n") |> 
  filter(!is.na(value)) |> 
  # filter(value %in% c("INGHAM", "BUNDABERG")) |> 
  left_join(df_facilities, by = c("value" = "FACILITY_NAME_Clean")) 

```


```{r}

```

