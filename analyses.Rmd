---
title: "analyses"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

```{r}
data_dir <- "U:\\Research\\Projects\\health\\jti_research_data\\jti_itraqi"
```

```{r}
df_facility_coords <- 
  haven::read_spss(file.path(data_dir, "D_Table_FacilityDescription.sav")) %>%
  select(facility = FACILITY_NAME_Clean, facility_latitude = Latitude, facility_longitude = Longitude)

list.files(data_dir)





df <- haven::read_spss(file.path(data_dir, "D_Table_TimeAndLocation_LongFile.sav")) %>% filter(SELECT==1)



df2 <- haven::read_spss(file.path(data_dir, "D_Table_TimeAndLocation_LongFileSELECT.sav"))


identical(
  df %>% filter(SELECT==1) %>% select(-SELECT),
  df2
)

df %>% filter(SELECT==1)

get_dest_and_times <- function(id) {
  df_short <- df %>%
    filter(pu_id == id) %>%
    select(Sequence, TimeWayPoint, DateTimePoints, X_COORD, Y_COORD, FacilityFixed) %>%
    left_join(df_facility_coords, by = c("FacilityFixed" = "facility")) %>%
    mutate(
      x = coalesce(X_COORD, facility_longitude),
      y = coalesce(Y_COORD, facility_latitude)
    ) %>%
    select(-c(X_COORD, facility_longitude, Y_COORD, facility_latitude))
  
  df_short %>%
    slice(if(any(TimeWayPoint == "D_DEPART_SCENE")) 1:which.max(TimeWayPoint == "D_DEPART_SCENE") else row_number())
  
  
  
  df_short %>% 
    filter(!is.na(x)) 
  
  browser()
}


df_ambulance <-
  df %>%
  group_by(pu_id) %>%
  slice(if(any(TimeWayPoint == "D_DEPART_SCENE")) 1:which.max(TimeWayPoint == "D_DEPART_SCENE") else 0) %>%
  fill(X_COORD, Y_COORD) %>%
  ungroup()

df_ambulance %>%
  select(pu_id, SourceRecordID, TimeWayPoint, DateTimePoints) %>%
  pivot_wider(names_from = TimeWayPoint, values_from = DateTimePoints) %>%
  mutate(scene_duration_mins = as.numeric(difftime(D_DEPART_SCENE, D_ON_SCENE, units = "mins"))) %>%
  ggplot(aes(scene_duration_mins)) +
  geom_histogram()


df_ambulance %>%
  select(pu_id, SourceRecordID, TimeWayPoint, DateTimePoints) %>%
  pivot_wider(names_from = TimeWayPoint, values_from = DateTimePoints) %>%
  filter(!is.na(D_AT_DEST)) %>%
  mutate(scene_duration_dept_to_dest = as.numeric(difftime(D_AT_DEST, D_DEPART_SCENE, units = "mins"))) %>%
  ggplot(aes(scene_duration_dept_to_dest)) +
  geom_histogram()

df_ambulance %>%
  filter(pu_id == 26994)

# get_dest_and_times(293)

df %>% filter(pu_id == 8197)

df_ambulance %>%
  select(pu_id, SourceRecordID, TimeWayPoint, DateTimePoints) %>%
  filter(TimeWayPoint %in% c("D_AT_DEST", "D_DEPART_SCENE")) %>% filter(pu_id == 8197)
  # pivot_wider(names_from = TimeWayPoint, values_from = DateTimePoints)  %>% filter(pu_id == 8197)

df_amb_time <-
  df %>%
  select(pu_id, SourceRecordID, TimeWayPoint, DateTimePoints) %>%
  group_by(pu_id, SourceRecordID) %>%
  filter(TimeWayPoint %in% c("D_AT_DEST", "D_DEPART_SCENE")) %>%
  pivot_wider(names_from = TimeWayPoint, values_from = DateTimePoints) %>%
  mutate(scene_duration_dept_to_dest = as.numeric(difftime(D_AT_DEST, D_DEPART_SCENE, units = "mins"))) 

df_amb_time %>%
  ggplot(aes(scene_duration_dept_to_dest)) +
  geom_histogram()

```


```{r}
df %>%
  select(pu_id, SourceRecordID, TimeWayPoint, DateTimePoints) %>%
  group_by(pu_id) %>%
  filter(TimeWayPoint %in% c("D_RECEIVED",
                             "D_AT_DEST", 
                             "D_AT_DEST_CAD", 
                             "ED_START_DATETIME_Formatted", 
                             "Hosp_START_DATETIME_Formatted")) %>%
  pivot_wider(names_from = TimeWayPoint, values_from = DateTimePoints) %>%
  mutate(start_time = D_RECEIVED,
         end_time = coalesce(D_AT_DEST, D_AT_DEST_CAD, ED_START_DATETIME_Formatted, Hosp_START_DATETIME_Formatted),
         journey_hours = as.numeric(difftime(end_time, start_time, units = "hours"))) %>%
  select(pu_id, SourceRecordID, journey_hours) %>%
  na.omit() %>%
  ggplot(aes(journey_hours)) + geom_histogram()

# need to calculate time between D_ON_SCENE to D_DEPART_SCENE and subtract this from journey-hours as this was not considered into iTRAQI

df %>% plyr::count("TimeWayPoint") %>% arrange(desc(freq))


df %>% 
  filter(TimeWayPoint %in% c("D_RECEIVED",
                             "D_COMPLETED")) %>%
  group_by(pu_id, SourceRecordID) %>%
  pivot_wider(names_from = TimeWayPoint, values_from = DateTimePoints) 
```

```{r}
df

df2 <- haven::read_spss(file.path(data_dir, "D_Table_HealthService_Time_UniqueLocation_Transport1stEnc_Summary.sav"))
# df2 <- haven::read_spss(file.path(data_dir, "F_TableFlagsANDOutcomesSELECT.sav"))

```


```{r}

```


```{r}
library(sf)
qld_boundary <- read_sf("input/qld_state_polygon_shp/QLD_STATE_POLYGON_shp.shp")
qld_fill <- "darkolivegreen3"

bad_coord_pu_ids <- c(1685722)  


df %>%
  filter(
    !is.na(X_COORD),
    TimeWayPoint == "D_RECEIVED",
    !pu_id %in% bad_coord_pu_ids
  ) %>%
  left_join(select(df_amb_time, pu_id, SourceRecordID, scene_duration_dept_to_dest), by = c("pu_id", "SourceRecordID")) %>%
  filter(!is.na(scene_duration_dept_to_dest)) %>%
  ggplot() + 
  geom_sf(data=qld_boundary, fill = qld_fill, col="transparent") +
  geom_point(aes(X_COORD, Y_COORD, col = scene_duration_dept_to_dest)) +
  # + geom_text(aes(x=X_COORD, y=Y_COORD, label = pu_id), hjust=1)
  labs(x="", y="")

df %>%
  filter(pu_id == 1685722)


df %>% plyr::count("TimeWayPoint") %>% arrange(desc(freq))
```

D_RECEIVED: the time that ambulance got the call
D_CLEAR: ambulance has been available for dispatched to other cases (no longer involved in that pu_id)
ED_START_DATETIME_Formatted: patient handed over to ED


check difference between 'Hosp_START_DATETIME_Formatted' and 'ED_START_DATETIME_Formatted'
  - which comes first
  - "arrive at hosp time" = coalesce(ED-start, hosp-start)

we are attempting to replicate iTRAQI by trying to capture first call of ambulance to arrival at hospital (total time for patient retrieval)

compare observed times (DEPART_SCENE to arrival - above) to estimated times using osrm/arcgis
  - does this match up with our idea of the ideal facility?
  - did they take longer than an hour and end up at a major trauma centre
    -> if so, was there a closer, secondary centre?

  
first pass:
  > d_recieved to 'ed and first facility'
  > d_recieved to 'ed at secondary facility (first tertiary care/major trauma care - PAH/RBWH/GC/TOWNSVILLE)'
  > use 'D_Table_HealthService_Time_UniqueLocation_Transport1stEnc_Summary.sav' - `DateTimePoints_first`


are those times within the range for iTRAQI for that SA1


```{r}
tertiary_care_centres <- c(
  "RBWH",
  "PRINCESS ALEXANDRA",
  "GOLD COAST",
  "TOWNSVILLE"
)


df2 %>% 
  mutate(tertiary_care = FACILITY_NAME_Clean %in% tertiary_care_centres) %>% 
  group_by(pu_id) %>%
  arrange(LocationChangeSequence) %>%
  slice(if(any(tertiary_care == 1)) 1:which.max(tertiary_care==1) else row_number()) %>%
  mutate(first_dest = row_number() == 2) %>%
  filter(!(FACILITY_NAME_Clean == "AMBULANCE" & first_dest)) %>%
  mutate(first_dest = row_number() == 2)
```

# questions for group
```{r, eval=FALSE}

# What does it mean when someone goes from ambulance to ambulance?
  #> adam reckons a non-transport case or a private facility
df2 %>% 
  mutate(tertiary_care = FACILITY_NAME_Clean %in% tertiary_care_centres) %>% 
  group_by(pu_id) %>%
  arrange(LocationChangeSequence) %>%
  slice(if(any(tertiary_care == 1)) 1:which.max(tertiary_care==1) else row_number()) %>%
  mutate(first_dest = row_number() == 2) %>%
  filter(first_dest & FACILITY_NAME_Clean == "AMBULANCE")

df2 %>%
  filter(pu_id == 294328)


df %>% 
  filter(pu_id == 294328)
```

